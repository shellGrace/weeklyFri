---
date: 2023/08/25
---

<img src="https://i.ibb.co/pZgFLtC/shamolvzhou.jpg" width="800" />

<small>å°é¢å›¾æ¥æºäºé˜¿æ‹‰å–„æ²™æ¼ ğŸœï¸ç»¿æ´²ï¼Œå²ä¸Šæœ€å¼€å¿ƒçš„ä¸€æ¬¡æ—…è¡Œï¼Œå¿…é¡»è¦è®°å½•ä¸‹ã€‚</small>


### æŠ€æœ¯åˆ†äº«-è®¾è®¡æ¨¡å¼ç›¸å…³

## Visitorè®¿é—®è€…æ¨¡å¼

### åŸç†
æ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ª accept æ–¹æ³•ï¼Œæ¥æ”¶ä¸€ä¸ªè®¿é—®è€…ä½œä¸ºå‚æ•°ã€‚è®¿é—®è€…ç±»å®ç°äº†å¯¹æ¯ç§å…ƒç´ ç±»å‹çš„è®¿é—®æ–¹æ³•ã€‚å½“è®¿é—®è€…è®¿é—®å…ƒç´ æ—¶ï¼Œå…ƒç´ ä¼šè°ƒç”¨è®¿é—®è€…çš„å¯¹åº”æ–¹æ³•ï¼Œå¹¶å°†è‡ªèº«ä¼ é€’ç»™è¯¥æ–¹æ³•ã€‚

### ä¸»è¦ç»„æˆéƒ¨åˆ†
Elementï¼ˆå…ƒç´ ï¼‰ï¼šè¿™æ˜¯å¯¹è±¡ç»“æ„ä¸­çš„æ¥å£æˆ–æŠ½è±¡ç±»ï¼Œå®šä¹‰äº†ä¸€ä¸ª accept æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªè®¿é—®è€…å¯¹è±¡ä½œä¸ºå‚æ•°ã€‚  
ConcreteElementï¼ˆå…·ä½“å…ƒç´ ï¼‰ï¼šå®ç°äº† Element æ¥å£çš„ç±»ã€‚å®ƒä»¬åœ¨å®ç°çš„ accept æ–¹æ³•ä¸­è°ƒç”¨è®¿é—®è€…çš„ç›¸åº”æ–¹æ³•ï¼Œå°†è‡ªèº« (this) ä¼ é€’ç»™è®¿é—®è€…ã€‚  
Visitorï¼ˆè®¿é—®è€…ï¼‰ï¼šå®šä¹‰äº†ä¸€ä¸ªæ¥å£æˆ–æŠ½è±¡ç±»ï¼ŒåŒ…å«è®¿é—®æ‰€æœ‰å…·ä½“å…ƒç´ çš„æ–¹æ³•ï¼Œé€šå¸¸æ˜¯ visitConcreteElementAã€visitConcreteElementB ç­‰ã€‚  
ConcreteVisitorï¼ˆå…·ä½“è®¿é—®è€…ï¼‰ï¼šå®ç°äº† Visitor æ¥å£çš„ç±»ã€‚æ¯ä¸ªå…·ä½“è®¿é—®è€…ç±»éƒ½å®ç°äº†è®¿é—®ä¸åŒå…ƒç´ çš„å…·ä½“æ“ä½œã€‚  

å®šä¹‰å…ƒç´ æ¥å£å’Œå…ƒç´ ç±»
```javascript
// Element æ¥å£
class Element {
  accept(visitor) {
    throw new Error('This method must be overridden!');
  }
}
// å…ƒç´ ç±»ï¼šFunctionElement
class FunctionElement extends Element {
  operation() {
    return 'Function Operation';
  }
  accept(visitor) {
    visitor.visitFunctionElement(this);
  }
}
// å…ƒç´ ç±»ï¼šObjectElement
class ObjectElement extends Element {
  operation() {
    return 'Object Operation';
  }
  accept(visitor) {
    visitor.visitObjectElement(this);
  }
}
// å…ƒç´ ç±»ï¼šStringElement
class StringElement extends Element {
  operation() {
    return 'String Operation';
  }
  accept(visitor) {
    visitor.visitStringElement(this);
  }
}
```

å®šä¹‰è®¿é—®è€…æ¥å£å’Œå…·ä½“è®¿é—®è€…ç±»
```javascript
// Visitor æ¥å£
class Visitor {
  visitFunctionElement(functionElement) {
    throw new Error('This method must be overridden!');
  }

  visitObjectElement(objectElement) {
    throw new Error('This method must be overridden!');
  }

  visitStringElement(stringElement) {
    throw new Error('This method must be overridden!');
  }
}

// å…·ä½“è®¿é—®è€…ç±»ï¼šConcreteVisitor1
class ConcreteVisitor1 extends Visitor {
  visitFunctionElement(functionElement) {
    console.log(`ConcreteVisitor1 logs ${functionElement.operation()}`);
  }

  visitObjectElement(objectElement) {
    console.log(`ConcreteVisitor1 logs ${objectElement.operation()}`);
  }

  visitStringElement(stringElement) {
    console.log(`ConcreteVisitor1 logs ${stringElement.operation()}`);
  }
}

// å…·ä½“è®¿é—®è€…ç±»ï¼šConcreteVisitor2
class ConcreteVisitor2 extends Visitor {
  visitFunctionElement(functionElement) {
    console.log(`ConcreteVisitor2 processes ${functionElement.operation()}`);
  }

  visitObjectElement(objectElement) {
    console.log(`ConcreteVisitor2 processes ${objectElement.operation()}`);
  }

  visitStringElement(stringElement) {
    console.log(`ConcreteVisitor2 processes ${stringElement.operation()}`);
  }
}
```

ä½¿ç”¨è®¿é—®è€…æ¨¡å¼
```javascript
// åˆ›å»ºå…·ä½“å…ƒç´ å¯¹è±¡
const elements = [
  new FunctionElement(),
  new ObjectElement(),
  new StringElement()
];

// åˆ›å»ºå…·ä½“è®¿é—®è€…å¯¹è±¡
const visitor1 = new ConcreteVisitor1();
const visitor2 = new ConcreteVisitor2();

// ä½¿ç”¨è®¿é—®è€…æ¨¡å¼
elements.forEach(element => {
  element.accept(visitor1); // ä½¿ç”¨è®¿é—®è€…1
  element.accept(visitor2); // ä½¿ç”¨è®¿é—®è€…2
});
```

å®Œæ•´çš„å®ç°
```javascript
// å®šä¹‰å…ƒç´ æ¥å£
class Element {
  accept(visitor) {
    throw new Error("This method must be overridden!");
  }
}

// å…·ä½“å…ƒç´  - å‡½æ•°å…ƒç´ 
class ConcreteFunctionElement extends Element {
  accept(visitor) {
    visitor.visitConcreteFunctionElement(this);
  }

  operation() {
    return 'Function Element';
  }
}

// å…·ä½“å…ƒç´  - å¯¹è±¡å…ƒç´ 
class ConcreteObjectElement extends Element {
  accept(visitor) {
    visitor.visitConcreteObjectElement(this);
  }

  operation() {
    return 'Object Element';
  }
}

// å…·ä½“å…ƒç´  - å­—ç¬¦ä¸²å…ƒç´ 
class ConcreteStringElement extends Element {
  accept(visitor) {
    visitor.visitConcreteStringElement(this);
  }

  operation() {
    return 'String Element';
  }
}

// è®¿é—®è€…æ¥å£
class Visitor {
  visitConcreteFunctionElement(element) {
    throw new Error("This method must be overridden!");
  }

  visitConcreteObjectElement(element) {
    throw new Error("This method must be overridden!");
  }

  visitConcreteStringElement(element) {
    throw new Error("This method must be overridden!");
  }
}

// å…·ä½“è®¿é—®è€…1
class ConcreteVisitor1 extends Visitor {
  visitConcreteFunctionElement(element) {
    console.log(`ConcreteVisitor1 logs ${element.operation()}`);
  }

  visitConcreteObjectElement(element) {
    console.log(`ConcreteVisitor1 logs ${element.operation()}`);
  }

  visitConcreteStringElement(element) {
    console.log(`ConcreteVisitor1 logs ${element.operation()}`);
  }
}

// å…·ä½“è®¿é—®è€…2
class ConcreteVisitor2 extends Visitor {
  visitConcreteFunctionElement(element) {
    console.log(`ConcreteVisitor2 processes ${element.operation()}`);
  }

  visitConcreteObjectElement(element) {
    console.log(`ConcreteVisitor2 processes ${element.operation()}`);
  }

  visitConcreteStringElement(element) {
    console.log(`ConcreteVisitor2 processes ${element.operation()}`);
  }
}

// ä½¿ç”¨è®¿é—®è€…æ¨¡å¼
const elements = [
  new ConcreteFunctionElement(),
  new ConcreteObjectElement(),
  new ConcreteStringElement()
];

const visitor1 = new ConcreteVisitor1();
const visitor2 = new ConcreteVisitor2();

elements.forEach(element => {
  element.accept(visitor1);
  element.accept(visitor2);
});
```

Qï¼šåœ¨ Visitor æ¨¡å¼ä¸­ï¼Œä¸ºä»€ä¹ˆæ¯ä¸ªè®¿é—®è€…ç±»ï¼ˆå¦‚ ConcreteVisitor1 å’Œ ConcreteVisitor2ï¼‰éƒ½éœ€è¦ä¸ºæ‰€æœ‰çš„å…ƒç´ ç±»å‹ï¼ˆå¦‚å‡½æ•°ã€å¯¹è±¡ã€å­—ç¬¦ä¸²ç­‰ï¼‰å®šä¹‰å…·ä½“çš„å¤„ç†æ–¹æ³•
Aï¼šè®¿é—®è€…æ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ“ä½œçš„é€»è¾‘å’Œå…ƒç´ å¯¹è±¡çš„ç»“æ„è§£è€¦ï¼Œä»è€Œå¯ä»¥åœ¨ä¸ä¿®æ”¹å…ƒç´ ç±»çš„æƒ…å†µä¸‹æ‰©å±•æ“ä½œ

Qï¼šä¸ºä»€ä¹ˆå…ƒç´ æŒ‰ç±»å‹å®šä¹‰ï¼Œè€Œæ¯ä¸ªè®¿é—®è€…éœ€è¦å¤„ç†æ‰€æœ‰ç±»å‹çš„å…ƒç´ 
Aï¼š æ¯ä¸ªå…ƒç´ ç±»ï¼ˆConcreteElementï¼‰è¡¨ç¤ºä¸€ç§ç‰¹å®šçš„ç»“æ„æˆ–ç±»å‹ã€‚å°†æ‰€æœ‰å¯èƒ½çš„æ“ä½œé›†ä¸­åœ¨è®¿é—®è€…ä¸­ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹å®šä¹‰å¯¹æ‰€æœ‰å…ƒç´ ç±»å‹çš„æ“ä½œï¼Œè€Œæ— éœ€ä¿®æ”¹å…ƒç´ ç±»æœ¬èº«ã€‚


## å‘å¸ƒè®¢é˜…

## åŸç†
è®¢é˜…è€…æŠŠè‡ªå·±æƒ³è®¢é˜…çš„äº‹ä»¶å¤„ç†å‡½æ•°æ³¨å†Œåˆ°ç»Ÿä¸€çš„è°ƒåº¦ä¸­å¿ƒä¸­ï¼Œå½“å‘å¸ƒè€…å‘è°ƒåº¦ä¸­å¿ƒå‘å¸ƒæ•°æ®æ—¶ï¼Œç”±è°ƒåº¦ä¸­å¿ƒç»Ÿä¸€è°ƒç”¨è®¢é˜…è€…æ³¨å†Œåˆ°è°ƒåº¦ä¸­å¿ƒçš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚
å½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–å®ƒçš„å¯¹è±¡éƒ½å°†å¾—åˆ°é€šçŸ¥å¹¶æ‰§è¡Œç›¸åº”æ“ä½œã€‚

è°ƒåº¦è€…ï¼šç®¡ç†äº‹ä»¶å’Œé€šçŸ¥çš„ä¸­ä»‹
å‘å¸ƒè€…ï¼šemit(eventName[, ...args]): ç”¨äºå‘å¸ƒï¼ˆè§¦å‘ï¼‰æŒ‡å®šçš„äº‹ä»¶ã€‚å¯ä»¥ä¼ é€’äº‹ä»¶åç§°å’Œä¸€äº›å¯é€‰çš„å‚æ•°ï¼Œä»¥ä¾¿åœ¨äº‹ä»¶è¢«è§¦å‘æ—¶ä¼ é€’ç»™äº‹ä»¶å¤„ç†å‡½æ•°ã€‚
è®¢é˜…è€…ï¼šon(eventName, listener): ç”¨äºè®¢é˜…ï¼ˆç›‘å¬ï¼‰æŒ‡å®šçš„äº‹ä»¶ã€‚å½“äº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œå·²æ³¨å†Œçš„ç›‘å¬å™¨listenerå‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚å¯ä»¥ä¸ºåŒä¸€ä¸ªäº‹ä»¶åç§°æ³¨å†Œå¤šä¸ªç›‘å¬å™¨ã€‚


## æ‰‹å†™å‘å¸ƒè®¢é˜…
```javascript
// å®ç°â¾ƒå®šä¹‰äº‹ä»¶
// ç¼–å†™â¼€ä¸ªç®€å•çš„â¾ƒå®šä¹‰äº‹ä»¶å¤„ç†å™¨
// 1. å…·å¤‡ on â½…æ³•ç»‘å®šäº‹ä»¶
// 2. å…·å¤‡ off â½…æ³•è§£ç»‘äº‹ä»¶
class EventEmitter {
    constructor() {
        this.events = {}; // è°ƒåº¦ä¸­å¿ƒ
    }
    // ç›‘å¬å™¨
    on(event, listener) {
        if(this.events[event]) {
            this.events[event].push(listener);
        } else {
            this.events[event] = [listener];
        }
    }
    // è§¦å‘å™¨
    emit(event, ...args) {
        // å…ˆå¤„ç†é€šé…ç¬¦
        if(event === '*') {
            Object.keys(this.events).forEach(key => {
                this.events[key].forEach(listener => {
                    listener(...args);
                });
            });
            return;
        }
        if(this.events[event]) {
            this.events[event].forEach(listener => {
                listener(...args);
            });
        }
    }
    off(event, listener) {
        if(this.events[event] && listener) {
            this.events[event] = this.events[event].filter(l => l !== listener);
        } else {
            delete this.events[event];
        }
    }
}


var emitter = new EventEmitter();

emitter.on('foo', function(e){
    console.log('listening foo event 1', e);
});

emitter.on('foo', function(e){
    console.log('listening foo event 2', e);
});

emitter.on('bar', function(e){
    console.log('listening bar event', e);
});

// // ç›‘å¬å…¨éƒ¨äº‹ä»¶
emitter.on('*', function(e){
    // æ„æ€å°±æ˜¯ä¸ç®¡ä»€ä¹ˆäº‹ä»¶è¢«è§¦å‘ï¼Œéƒ½ä¼šè¢«ç›‘å¬åˆ°
    console.log('listening all events');
});

emitter.emit('foo', {name : 'John'});
emitter.emit('bar', {name : 'Sun'});
emitter.emit('*', {name : 'Sun'}); // å…ˆè§¦å‘ï¼Œåç›‘å¬åˆ°ï¼Œå†æ‰§è¡Œç›‘å¬å›è°ƒ

emitter.off('foo');
```
